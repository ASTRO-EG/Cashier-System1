<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>🍔 AppCashier</title>

<!-- favicon: 🍔 (SVG data URL) -->
<link id="faviconLink" rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='18' fill='%23FFB74D'/%3E%3Ctext x='50' y='62' font-size='46' text-anchor='middle' font-family='Arial,sans-serif'%3E%F0%9F%8D%94%3C/text%3E%3C/svg%3E">

<style>
/* ================== AppCashier — Single HTML (Mobile-first Portrait) ================== */
/* Base */
:root{--transition:180ms}
*{box-sizing:border-box}
html,body{height:100%;margin:0;padding:0;font-family:"IBM Plex Sans Arabic",system-ui,Roboto,Arial;direction:rtl;-webkit-font-smoothing:antialiased;overflow-x:hidden}
body[data-theme]{transition:background var(--transition),color var(--transition)}

/* Default theme variables (kept as before) */
[data-theme]{
  --bg: linear-gradient(180deg,#071014,#071219);
  --panel-bg: rgba(8,18,20,0.85);
  --accent:#00BCD4; --accent-2:#26c6da;
  --text:#E6F7F8; --muted:rgba(255,255,255,0.03);
  --card-border: rgba(255,255,255,0.04);
  --shadow: rgba(0,0,0,0.5);
  /* contrast overrides (we will set per-theme) */
  --input-text: var(--text);
  --text-contrast: var(--text);
  /* تحسين التباين للأصناف */
  --item-text: #FFFFFF;
  /* danger variable for amounts/buttons */
  --danger: #ff5252;
}

/* gradient theme (unchanged colors) + text contrast kept white */
body[data-theme="gradient"]{
  --bg: linear-gradient(-45deg,#6a11cb,#2575fc,#6a11cb,#2575fc);
  --panel-bg: rgba(10,12,20,0.72);
  --accent:#7b61ff; --accent-2:#00bcd4; --text:#ffffff;
  --card-border: rgba(255,255,255,0.06);
  --shadow: rgba(8,8,20,0.45);
  --input-text: #ffffff;
  --text-contrast: #ffffff;
  --item-text: #FFFFFF;
}

/* neon (unchanged) */
body[data-theme="neon"]{
  --bg: linear-gradient(180deg,#050405,#0b0710);
  --panel-bg: rgba(5,5,5,0.85);
  --accent:#00e5ff; --accent-2:#ff3dcb; --text:#e6f9fb;
  --card-border: rgba(0,230,255,0.06);
  --shadow: rgba(0,0,0,0.7);
  --input-text: #e6f9fb;
  --text-contrast: #e6f9fb;
  --item-text: #FFFFFF;
}

/* bright (unchanged colors) BUT override inputs/text to dark for contrast */
body[data-theme="bright"]{
  --bg: linear-gradient(120deg,#f6d365,#fda085,#84fab0,#8fd3f4);
  --panel-bg: #ffffff;
  --accent:#0288d1; --accent-2:#039be5; --text:#222222;
  --card-border: rgba(0,0,0,0.06);
  --shadow: rgba(0,0,0,0.08);
  /* ensure inputs and numbers readable on light panel */
  --input-text: #222222;
  --text-contrast: #222222;
  --item-text: #222222;
}

/* Animated bg for gradient/bright */
@keyframes bgMove {0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
body[data-theme="gradient"], body[data-theme="bright"]{background:var(--bg);background-size:400% 400%;animation:bgMove 12s ease infinite}
body[data-theme="neon"]{background:var(--bg);background-size:cover}

/* App layout */
.app{max-width:980px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}
.header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;position:sticky;top:0;z-index:60;background:transparent;backdrop-filter:blur(6px)}
.brand{display:flex;align-items:center;gap:10px;font-weight:800;color:var(--text-contrast)}
.brand .logo{font-size:22px}
.theme-wrap{position:relative}

/* theme button/menu */
.theme-btn{padding:10px 14px;border-radius:999px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;font-weight:800;cursor:pointer}
.theme-menu{position:absolute;right:0;top:58px;background:var(--panel-bg);border:1px solid var(--card-border);padding:8px;border-radius:12px;display:flex;flex-direction:column;gap:8px;box-shadow:0 8px 30px var(--shadow);transform-origin:top right;opacity:0;visibility:hidden;transform:translateY(-6px) scale(.98);transition:all 160ms}
.theme-menu.show{opacity:1;visibility:visible;transform:translateY(0) scale(1)}
.theme-item{padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:800;color:var(--text-contrast)}
.theme-item:hover{background:var(--muted)}

/* Views */
.views{flex:1;display:flex;flex-direction:column;padding-bottom:72px}
.panel{background:var(--panel-bg);margin:12px;border-radius:12px;padding:12px;border:1px solid var(--card-border);box-shadow:0 10px 30px var(--shadow)}

/* Items grid: preserve order & layout EXACTLY but ensure visibility on mobile by allowing horizontal scroll inside panel */
.items-area{overflow:auto;padding:8px}
.items-grid{display:grid;grid-template-rows:repeat(15,minmax(58px,1fr));grid-auto-columns:minmax(260px,1fr);grid-auto-flow:column;gap:12px;padding:6px;width:max-content}
.item-box{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-radius:10px;padding:10px;display:flex;align-items:center;justify-content:space-between;min-width:220px;border:1px solid var(--card-border)}
.item-number{font-weight:900;padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02);font-weight:900;color:var(--accent)}
/* تحسين وضوح نص الأصناف */
.item-name{flex:1;margin-right:8px;font-weight:900;color:var(--item-text);text-shadow:0 1px 2px rgba(0,0,0,0.3)}

/* quantity & inputs: use --input-text for color (ensures contrast) */
.quantity-input{width:76px;padding:10px;border-radius:8px;border:2px solid var(--card-border);background:transparent;color:var(--input-text);font-weight:900;text-align:center;appearance:textfield}
.quantity-input::placeholder{color:rgba(255,255,255,0.5)}
.quantity-input:focus{outline:none;border-color:var(--accent);box-shadow:0 8px 18px rgba(0,0,0,0.14)}

/* amount & summary */
.control-flex{display:flex;gap:12px;align-items:flex-end}
#totalAmount{width:100%;padding:12px;border-radius:10px;border:3px solid var(--card-border);background:transparent;color:var(--input-text);font-weight:900;text-align:center}

/* bottom nav fixed */
.bottom-nav{position:fixed;left:0;right:0;bottom:0;display:flex;justify-content:center;padding:10px;background:linear-gradient(180deg,transparent,rgba(0,0,0,0.08));z-index:80}
.nav-bar{max-width:980px;width:100%;display:flex;justify-content:space-around;gap:8px;padding:8px 12px;background:var(--panel-bg);border-radius:18px;margin:0 12px;border:1px solid var(--card-border);box-shadow:0 10px 30px var(--shadow)}
.nav-btn{flex:1;padding:12px;border-radius:12px;background:transparent;border:none;color:var(--text-contrast);font-weight:800;display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer}
.nav-btn.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;box-shadow:0 8px 22px rgba(0,0,0,0.2)}

/* view switching animation */
.view{display:none;opacity:0;transform:translateY(8px);transition:opacity 240ms,transform 240ms}
.view.show{display:block;opacity:1;transform:translateY(0)}

/* modal */
.modal{position:fixed;left:0;right:0;top:0;bottom:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:100}
.modal .modal-content{width:92%;max-width:420px;padding:18px;border-radius:12px;background:var(--panel-bg);border:1px solid var(--card-border)}

/* splash */
.splash{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;background:linear-gradient(180deg,#071018,#071218);z-index:200}
.splash .logo{width:92px;height:92px;border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:44px;background:linear-gradient(90deg,var(--accent),var(--accent-2));box-shadow:0 12px 40px rgba(0,0,0,0.35)}
.loader{width:46px;height:46px;border-radius:50%;position:relative}
.loader:after{content:"";position:absolute;left:0;top:0;width:100%;height:100%;border-radius:50%;border:4px solid rgba(255,255,255,0.12);border-top-color:#fff;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* small screens */
@media (max-width:720px){
  .items-grid{grid-auto-columns:minmax(240px,1fr)}
  .quantity-input{width:64px}
  #totalAmount{font-size:16px}
}

/* Ensure no horizontal overflow globally */
html,body{overflow-x:hidden}

/* ================== تحسين وضوح نص السجل فقط ================== */
#view-records { color: #eaf9ff !important; }
#view-records .panel { background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent); }
#view-records h2, #view-records strong, #view-records small, #view-records button, #view-records p, #view-records li { color: #ffffff !important; }
#view-records li span { color: #4fc3f7 !important; font-weight:800; }
#view-records .period-log { padding:10px; border-radius:10px; margin-bottom:10px; border:1px solid rgba(255,255,255,0.04); background: rgba(255,255,255,0.02); }
</style>
</head>
<body data-theme="gradient">

<div class="app" id="appRoot">

  <!-- Header -->
  <header class="header">
    <div class="brand"><span class="logo">🍔</span><span>AppCashier</span></div>
    <div class="theme-wrap">
      <button class="theme-btn" id="themeToggleBtn" aria-expanded="false">🎨 تغيير الثيم</button>
      <div class="theme-menu" id="themeMenu" role="menu" aria-hidden="true">
        <div class="theme-item" data-theme-choice="gradient">🌈 المتدرج المتحرك</div>
        <div class="theme-item" data-theme-choice="neon">💡 النيون المتوهج</div>
        <div class="theme-item" data-theme-choice="bright">☀️ الفاتح النابض</div>
      </div>
    </div>
  </header>

  <!-- Splash -->
  <div class="splash" id="splash">
    <div class="logo" aria-hidden="true">🍔</div>
    <h1 style="margin:0;color:var(--text-contrast)">AppCashier</h1>
    <p style="margin:0;color:var(--text-contrast)">تحميل التطبيق...</p>
    <div class="loader" aria-hidden="true"></div>
  </div>

  <!-- Main views -->
  <main class="views" id="views">

    <!-- Login view (initial) -->
    <section id="view-login" class="view show" aria-live="polite">
      <div class="panel" style="max-width:520px;margin:14px auto;">
        <h2 style="margin:0 0 8px 0;color:var(--accent)">تسجيل الدخول</h2>
        <input id="loginUser" type="text" placeholder="اسم المستخدم (admin)" value="admin" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--card-border);margin-bottom:8px;background:transparent;color:var(--text-contrast);font-weight:700">
        <input id="loginPass" type="password" placeholder="كلمة المرور" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--card-border);margin-bottom:12px;background:transparent;color:var(--text-contrast);font-weight:700">
        <div style="display:flex;gap:10px">
          <button id="loginBtn" class="theme-btn" style="flex:1">دخول</button>
        </div>
      </div>
    </section>

    <!-- Home: Items + Amount -->
    <section id="view-home" class="view" aria-hidden="true">
      <div class="panel">
        <h2 style="margin:0 0 8px 0;color:var(--accent)">الأصناف</h2>
        <div class="items-area">
          <!-- Items grid keeps original columns/order; horizontal scroll allowed inside panel -->
          <div class="items-grid" id="itemsGrid"></div>
        </div>
      </div>

      <div class="panel" style="margin-top:8px">
        <h3 style="margin:0 0 8px 0;color:var(--accent)">تسجيل إجمالي الفترة الحالية</h3>
        <div class="control-flex">
          <div>
            <input id="totalAmount" type="number" placeholder="أدخل المبلغ الإجمالي هنا" min="0" style="width:100%" />
          </div>
          <div style="min-width:150px">
            <div style="background:linear-gradient(90deg,var(--accent),var(--accent-2));padding:10px;border-radius:10px;color:white;font-weight:900;text-align:center">
              إجمالي عدد الوحدات
              <div id="totalOrders" style="font-size:20px">0</div>
            </div>
          </div>
          <div style="min-width:150px">
            <button id="endPeriodBtn" class="theme-btn" style="width:100%">إنهاء الفترة</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Records (past periods) -->
    <section id="view-records" class="view" aria-hidden="true">
      <div class="panel">
        <h2 style="color:var(--accent);margin:0 0 8px 0">سجل الفترات السابقة</h2>
        <div id="pastContainer"></div>
        <div style="margin-top:8px">
          <button id="deleteAllBtn" style="width:100%;padding:12px;border-radius:10px;background:var(--danger);color:#fff;border:none;font-weight:800">حذف السجل بالكامل</button>
        </div>
      </div>
    </section>

    <!-- Report -->
    <section id="view-report" class="view" aria-hidden="true">
      <div class="panel">
        <h2 style="color:var(--accent);margin:0 0 8px 0">تقرير المبيعات</h2>
        <div id="reportDate" style="font-weight:800;margin-bottom:8px"></div>
        <div id="reportBox"></div>
      </div>
    </section>

  </main>

  <!-- Bottom navigation (fixed) -->
  <nav class="bottom-nav" aria-label="تنقّل">
    <div class="nav-bar" role="tablist">
      <button class="nav-btn active" id="nav-home" data-target="view-home" aria-selected="true">
        <div style="font-size:18px">🧾</div>
        <div>الأصناف</div>
      </button>
      <button class="nav-btn" id="nav-records" data-target="view-records" aria-selected="false">
        <div style="font-size:18px">📒</div>
        <div>السجل</div>
      </button>
      <button class="nav-btn" id="nav-report" data-target="view-report" aria-selected="false">
        <div style="font-size:18px">📊</div>
        <div>التقرير</div>
      </button>
    </div>
  </nav>

  <!-- Modal for admin confirmation -->
  <div class="modal" id="modal" aria-hidden="true">
    <div class="modal-content">
      <h3 id="modalTitle">تأكيد العملية</h3>
      <p id="modalMsg">الرجاء إدخال كلمة سر المدير</p>
      <input id="modalPass" type="password" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--card-border);margin-top:8px;background:transparent;color:var(--text-contrast)">
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="modalConfirm" class="theme-btn" style="flex:1">تأكيد</button>
        <button id="modalCancel" class="theme-btn" style="flex:1;background:transparent;border:1px solid var(--card-border)">إلغاء</button>
      </div>
    </div>
  </div>

</div>

<script>
/* ========================= AppCashier JS ========================= */
/* Config & data */
const LOGIN_PW = '1010';
const ADMIN_PW = '111975';
const THEME_KEY = 'appcashier_theme_v1';
const PERIODS_KEY = 'appcashier_periods_v1';

const ALL_ITEMS = [
"شاورمه كيذر","شاورمه شامي","شاورمه فينا","شاورمه طبق",
"مكرونه","كبيبه","ورق عنب","سلطه خضراء","طماطم مخلل","باذنجان مخلل","شيبسي","بابا غنوج","طرشي",
"كفته ص","سجق ص","كبده ص","مخ ص","روزبيف ص","جبنه رومي","فراخ بانيه ص","بيف برجر","سوسيس ",
"كفته شامي","سجق شامي","كبده شامي","مخ شامي","روزبيف شامي","سوسيس شامي","فراخ شامي",
"كفته فينا","سجق فينا","كبده فينا","مخ فينا","روزبيف فينا","سوسيس فينا","فراخ فينا",
"جبنه رومي فينا",
" مانجو"," فراوله"," رمان"," برتقال","عنب"," جوافه"," موز"," كانتالوب","كوكتيل ",
"كولا","سبرايت","فانتا","دايت ","مياه معدنيه",
"ليمون","بطيخ","كانز ص","كانز ك"
];

let pastPeriods = [];
let audioContext = null;

/* Helpers */
const $ = id=>document.getElementById(id);

/* -- Theme handling -- */
function applyTheme(theme){
  document.body.setAttribute('data-theme', theme);
  try{ localStorage.setItem(THEME_KEY, theme); }catch(e){}
  document.querySelectorAll('.theme-item').forEach(it=> it.style.background = (it.dataset.themeChoice === theme) ? 'rgba(255,255,255,0.03)' : 'transparent');
}
(function initTheme(){
  let saved = null;
  try{ saved = localStorage.getItem(THEME_KEY); }catch(e){}
  if(!saved) saved = 'gradient';
  applyTheme(saved);
})();

$('themeToggleBtn').addEventListener('click', ()=>{ const m = $('themeMenu'); m.classList.toggle('show'); m.setAttribute('aria-hidden', m.classList.contains('show') ? 'false':'true'); });
document.addEventListener('click', e=>{ if(!e.target.closest('.theme-wrap')){ $('themeMenu').classList.remove('show'); $('themeMenu').setAttribute('aria-hidden','true'); }});
document.querySelectorAll('.theme-item').forEach(it=> it.addEventListener('click', ()=>{ applyTheme(it.dataset.themeChoice); $('themeMenu').classList.remove('show'); }));

/* -- Soft click audio (أكثر هدوءًا وبساطة) -- */
function initAudio(){ try{ audioContext = new (window.AudioContext || window.webkitAudioContext)(); }catch(e){ audioContext = null; } }
function playSoftClick(){
  if(!audioContext) initAudio();
  if(!audioContext) return;
  const ctx = audioContext;
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.type = 'sine';
  // تردد أقل وأكثر هدوءًا
  o.frequency.value = 800;
  g.gain.value = 0.0001;
  o.connect(g); g.connect(ctx.destination);
  o.start();
  // مدة أقصر وشدة أقل
  g.gain.setTargetAtTime(0.02, ctx.currentTime, 0.002);
  o.frequency.exponentialRampToValueAtTime(600, ctx.currentTime + 0.03);
  setTimeout(()=>{ 
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.02); 
    o.stop(ctx.currentTime + 0.03); 
  }, 30);
}

/* splash: play soft click once (or on first interaction if blocked) */
const splash = $('splash');
let splashPlayed = false;
function showSplashThenHide(){
  try{ playSoftClick(); splashPlayed = true; }catch(e){ splashPlayed = false; }
  if(!splashPlayed){
    const once = ()=>{ try{ playSoftClick(); }catch(e){}; window.removeEventListener('touchstart', once); window.removeEventListener('click', once); };
    window.addEventListener('touchstart', once, {passive:true}); window.addEventListener('click', once, {passive:true});
  }
  setTimeout(()=>{ splash.style.transition='opacity 300ms'; splash.style.opacity='0'; setTimeout(()=>{ splash.style.display='none'; }, 340); }, 1100);
}

/* -- PWA manifest creation (dynamic) -- */
(function createManifest(){
  const manifest = {
    "name":"AppCashier",
    "short_name":"AppCashier",
    "description":"نظام الكاشير - AppCashier",
    "start_url":".",
    "display":"standalone",
    "background_color":"#071018",
    "theme_color":"#2575fc",
    "icons":[
      {"src":"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='80' fill='%23FFB74D'/%3E%3Ctext x='256' y='310' font-size='220' text-anchor='middle' font-family='sans-serif'%3E%F0%9F%8D%94%3C/text%3E%3C/svg%3E","sizes":"512x512","type":"image/svg+xml"}
    ]
  };
  const blob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const link = document.createElement('link');
  link.rel = 'manifest';
  link.href = url;
  document.head.appendChild(link);
})();

/* -- Views & navigation (3 views + login) -- */
const views = ['view-login','view-home','view-records','view-report'];
function showView(id){
  views.forEach(v=>{
    const el = $(v);
    if(!el) return;
    if(v===id){ el.classList.add('show'); el.removeAttribute('aria-hidden'); }
    else{ el.classList.remove('show'); el.setAttribute('aria-hidden','true'); }
  });
  // bottom nav highlight
  document.querySelectorAll('.nav-btn').forEach(btn=>{ btn.classList.toggle('active', btn.dataset.target === id); btn.setAttribute('aria-selected', btn.dataset.target === id ? 'true':'false'); });
  // play click on navigation (except login initial)
  if(id !== 'view-login') try{ playSoftClick(); }catch(e){}
}

/* attach bottom nav */
document.querySelectorAll('.nav-btn').forEach(btn=> btn.addEventListener('click', ()=> showView(btn.dataset.target), {passive:true}));

/* -- Build items grid (KEEP ORDER EXACTLY) -- */
function buildItemsGrid(){
  const grid = $('itemsGrid'); grid.innerHTML = '';
  ALL_ITEMS.forEach((name, idx)=>{
    const safe = `input_${idx}`;
    const box = document.createElement('div'); box.className='item-box';
    box.innerHTML = `<div style="display:flex;align-items:center;gap:12px;"><div class="item-number">${idx+1}</div><div class="item-name">${name}</div></div><input id="${safe}" class="quantity-input" type="number" value="0" min="0" inputmode="numeric" aria-label="${name} كمية">`;
    grid.appendChild(box);
  });
  document.querySelectorAll('.quantity-input').forEach(inp=>{
    inp.addEventListener('input', throttle(updateTotal,120), {passive:true});
    inp.addEventListener('click', ()=> inp.select());
    inp.addEventListener('touchstart', ()=> inp.select(), {passive:true});
  });
}

/* throttle */
function throttle(fn, wait){
  let last=0, timeout=null;
  return function(...args){
    const now = Date.now(); const remaining = wait - (now - last);
    if(remaining <= 0){ if(timeout){ clearTimeout(timeout); timeout = null;} last = now; fn.apply(this,args); }
    else if(!timeout){ timeout = setTimeout(()=>{ last = Date.now(); timeout = null; fn.apply(this,args); }, remaining); }
  }
}

/* update total */
function updateTotal(){
  let total=0;
  ALL_ITEMS.forEach((_,i)=> { const v = parseInt($(`input_${i}`).value) || 0; if(v>0) total += v; });
  $('totalOrders').textContent = total;
}

/* -- Period logic -- */
function savePeriods(){ try{ localStorage.setItem(PERIODS_KEY, JSON.stringify(pastPeriods)); }catch(e){} }
function loadPeriods(){ try{ const s = localStorage.getItem(PERIODS_KEY); if(s) pastPeriods = JSON.parse(s); }catch(e){ pastPeriods = [];} renderPeriods(); }

function endPeriod(){
  const amount = parseFloat($('totalAmount').value);
  if(isNaN(amount) || amount <= 0){ alert('الرجاء إدخال المبلغ الإجمالي'); $('totalAmount').focus(); return; }
  const totalCnt = parseInt($('totalOrders').textContent) || 0;
  if(totalCnt === 0){ alert('لا يوجد أصناف مسجلة'); return; }
  const itemsLog = {};
  ALL_ITEMS.forEach((name,i)=>{ const v = parseInt($(`input_${i}`).value) || 0; if(v>0) itemsLog[name] = v; });
  const now = new Date();
  const period = { id: pastPeriods.length + 1, time: now.toLocaleTimeString('ar-EG'), date: now.toLocaleDateString('ar-EG'), totalAmount: amount, totalOrders: totalCnt, itemsLog };
  pastPeriods.push(period); savePeriods(); renderPeriods();
  // reset inputs
  $('totalAmount').value = ''; ALL_ITEMS.forEach((_,i)=> $(`input_${i}`).value = 0 );
  updateTotal();
  alert(`تم تسجيل الفترة بنجاح. المبلغ: ${amount}`);
}

/* render periods */
function renderPeriods(){
  const container = $('pastContainer'); container.innerHTML = '';
  if(pastPeriods.length === 0){ container.innerHTML = '<div style="padding:12px;color:var(--muted)">لا توجد فترات سابقة.</div>'; return; }
  pastPeriods.slice().reverse().forEach(p=>{
    const div = document.createElement('div'); div.className='period-log';
    let itemsHtml = '<ul style="padding-right:12px;margin:8px 0">';
    for(const key in p.itemsLog){ itemsHtml += `<li style="margin-bottom:6px"><strong>${key}:</strong> <span style="color:var(--accent);font-weight:800">${p.itemsLog[key]}</span></li>`; }
    itemsHtml += '</ul>';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><strong>فترة ${p.id}</strong><small>${p.time} — ${p.date}</small></div>
      <p style="margin:6px 0;font-weight:800">المبلغ: <span style="color:var(--danger);font-weight:900">${p.totalAmount}</span> — القطع: ${p.totalOrders}</p>
      ${itemsHtml}
      <div style="display:flex;gap:8px"><button style="flex:1;padding:8px;border-radius:8px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;font-weight:800" onclick="promptEdit(${p.id})">تعديل</button></div>`;
    container.appendChild(div);
  });
}

/* prompt edit */
function promptEdit(id){
  $('modalTitle').textContent = 'تأكيد التعديل';
  $('modalMsg').innerHTML = `الرجاء إدخال كلمة سر المدير لتعديل الفترة ${id}`;
  $('modalPass').value = ''; $('modal').style.display='flex'; $('modal').setAttribute('aria-hidden','false');
  $('modalConfirm').onclick = ()=> { handleModal('edit', id); };
  $('modalCancel').onclick = closeModal;
}
function handleModal(action, id){
  const val = $('modalPass').value;
  closeModal();
  if(val !== ADMIN_PW){ alert('كلمة سر خاطئة'); return; }
  if(action === 'edit') editPeriod(id);
  else if(action === 'delete') executeDeleteAll();
}
function closeModal(){ $('modal').style.display='none'; $('modal').setAttribute('aria-hidden','true'); }

/* edit period: load data to inputs & remove old */
function editPeriod(id){
  const idx = pastPeriods.findIndex(p=>p.id === id);
  if(idx === -1) return alert('لم يتم العثور على الفترة');
  const period = pastPeriods[idx];
  ALL_ITEMS.forEach((name,i)=> $(`input_${i}`).value = period.itemsLog[name] || 0 );
  $('totalAmount').value = period.totalAmount;
  pastPeriods.splice(idx,1); savePeriods(); renderPeriods();
  showView('view-home');
  alert('تم تحميل بيانات الفترة للتعديل. عدّل ثم اضغط "إنهاء الفترة" للحفظ.');
}

/* delete all - show modal for admin password (no extra confirm) */
$('deleteAllBtn').addEventListener('click', ()=> {
  $('modalTitle').textContent = 'تأكيد الحذف';
  $('modalMsg').textContent = 'الرجاء إدخال كلمة سر المدير لحذف السجل بالكامل';
  $('modalPass').value=''; $('modal').style.display='flex'; $('modal').setAttribute('aria-hidden','false');
  $('modalConfirm').onclick = ()=> { handleModal('delete'); };
  $('modalCancel').onclick = closeModal;
});
function executeDeleteAll(){ pastPeriods = []; savePeriods(); renderPeriods(); alert('تم حذف السجل.'); }

/* generate report */
function generateReport(){
  if(pastPeriods.length === 0){ alert('لا توجد بيانات للتقرير'); return; }
  const combined = {}; let totalMoney=0, totalUnits=0;
  pastPeriods.forEach(p=>{ totalMoney += Number(p.totalAmount); totalUnits += Number(p.totalOrders); for(const it in p.itemsLog) combined[it] = (combined[it]||0) + p.itemsLog[it]; });
  let rows=''; Object.keys(combined).forEach(k=> rows += `<tr><td>${k}</td><td>${combined[k]} قطعة</td></tr>`);
  const html = `<table class="report-table"><thead><tr><th>الصنف</th><th>الكمية</th></tr></thead><tbody>${rows}<tr class="report-total-row"><td>إجمالي القطع</td><td>${totalUnits} قطعة</td></tr><tr class="report-total-row"><td>الإجمالي المالي</td><td>${totalMoney.toFixed(2)}</td></tr></tbody></table>`;
  $('reportDate').textContent = new Date().toLocaleDateString('ar-EG');
  $('reportBox').innerHTML = html;
  showView('view-report');
}

/* Login flow */
$('loginBtn').addEventListener('click', ()=> {
  const u = $('loginUser').value.trim(), p = $('loginPass').value.trim();
  if(u === 'admin' && p === LOGIN_PW){
    buildItemsGrid(); loadPeriods(); showView('view-home');
    // hide splash if still visible
    if(splash && splash.style.display !== 'none') showSplashThenHide();
    // show bottom nav
    document.querySelector('.bottom-nav').style.display = 'block';
  } else alert('بيانات الدخول خاطئة');
});

/* end period */
$('endPeriodBtn').addEventListener('click', endPeriod);

/* nav short-cuts */
$('nav-home').addEventListener('click', ()=> showView('view-home'));
$('nav-records').addEventListener('click', ()=> { renderPeriods(); showView('view-records'); });
$('nav-report').addEventListener('click', ()=> generateReport());

/* initialization */
document.addEventListener('DOMContentLoaded', ()=>{
  // hide bottom nav until login
  document.querySelector('.bottom-nav').style.display = 'none';
  // show splash then hide
  showSplashThenHide();
  // preload stored periods
  try{ const s = localStorage.getItem(PERIODS_KEY); if(s) pastPeriods = JSON.parse(s); }catch(e){ pastPeriods = []; }
  // pre-init audio on first gesture (for autoplay restrictions)
  const initOnFirst = ()=>{ try{ initAudio(); }catch(e){}; window.removeEventListener('touchstart', initOnFirst); window.removeEventListener('click', initOnFirst); };
  window.addEventListener('touchstart', initOnFirst, {passive:true}); window.addEventListener('click', initOnFirst, {passive:true});
});

/* keep updating total for responsiveness */
function updateLoop(){ updateTotal(); requestAnimationFrame(updateLoop); }
requestAnimationFrame(updateLoop);

/* expose promptEdit for inline onclicks */
window.promptEdit = promptEdit;

/* attempt to lock orientation (best-effort) */
(function tryLock(){ if(screen.orientation && screen.orientation.lock) screen.orientation.lock('portrait').catch(()=>{}); })();

</script>
</body>
</html>