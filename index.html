<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cashier System</title>

  <!-- Google Font: Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    /* ---------------- Theme / Base ---------------- */
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --muted:#94a3b8;
      --text:#e6eef8;
      --accent:#06b6d4;
      --accent2:#7c3aed;
      --glass: rgba(255,255,255,0.03);
      --success:#16a34a;
      --danger:#ef4444;
      --transition: .22s ease;
      --font: 'Poppins', sans-serif;
    }
    body { margin:0; font-family:var(--font); -webkit-font-smoothing:antialiased; background:linear-gradient(180deg,var(--bg),#08101a); color:var(--text); padding:18px; }
    .wrap{ max-width:1100px; margin:8px auto; display:grid; grid-template-columns: 380px 1fr; gap:18px; align-items:start; }

    /* header */
    .header { grid-column:1/-1; display:flex; align-items:center; justify-content:space-between; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:14px 18px; box-shadow:0 6px 18px rgba(2,6,23,0.6); }
    .title { display:flex; align-items:center; gap:12px; }
    .logo { width:48px; height:48px; border-radius:10px; background:linear-gradient(135deg,var(--accent),var(--accent2)); display:flex; align-items:center; justify-content:center; font-weight:700; color:white; font-size:18px; }
    h1{ margin:0; font-size:18px; }
    .subtitle{ font-size:12px; color:var(--muted); margin-top:2px; }

    /* theme toggle top-left icon */
    #theme-toggle {
      position: fixed; top:12px; left:12px; z-index:9999; width:44px; height:44px; border-radius:999px;
      display:flex; align-items:center; justify-content:center; background:var(--card); color:var(--text);
      border:1px solid rgba(255,255,255,0.03); cursor:pointer; font-size:18px; box-shadow:0 6px 18px rgba(0,0,0,0.5);
      transition: transform .18s ease, background .18s ease;
    }
    #theme-toggle:hover{ transform: scale(1.06); }

    /* left panel (items) */
    .panel { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:14px; box-shadow: 0 6px 18px rgba(0,0,0,0.6); }
    .items { display:flex; flex-direction:column; gap:10px; max-height:66vh; overflow:auto; padding-right:6px; }
    .item { display:flex; gap:10px; align-items:center; justify-content:space-between; padding:8px; border-radius:10px; background:transparent; }
    .badge { min-width:44px; height:44px; border-radius:10px; background:rgba(255,255,255,0.02); display:flex;align-items:center;justify-content:center; font-weight:700; color:var(--accent); font-size:13px; }
    .item-name { font-weight:600; }
    .qty { width:96px; display:flex; gap:6px; align-items:center; }
    .qty input { width:56px; padding:8px; border-radius:8px; border:none; text-align:center; outline:none; font-weight:600; background:rgba(255,255,255,0.02); color:var(--text); }

    /* right panel */
    .summary { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:14px; box-shadow: 0 6px 18px rgba(0,0,0,0.6); display:flex; flex-direction:column; gap:10px; }
    .row { display:flex; justify-content:space-between; align-items:center; padding:8px 6px; }
    .big { font-size:24px; font-weight:800; }
    .small { font-size:13px; color:var(--muted); }

    .actions { display:flex; gap:8px; align-items:center; margin-top:6px; }
    .periods { margin-top:8px; display:flex; flex-direction:column; gap:8px; max-height:36vh; overflow:auto; padding-right:6px; }
    .period-card { background: rgba(255,255,255,0.02); padding:10px; border-radius:10px; display:flex; justify-content:space-between; align-items:center; }

    .btn { background:var(--glass); border:1px solid rgba(255,255,255,0.04); color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; font-size:13px; }
    .btn.primary { background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#fff; border:none; }
    .btn.warn { background:transparent; border:1px solid rgba(255,80,80,0.12); color:var(--danger); }

    .foot { grid-column:1/-1; text-align:center; font-size:12px; color:var(--muted); margin-top:6px; }

    /* modal */
    #password-modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:999; }
    .modal-content{ background:var(--card); color:var(--text); padding:20px; border-radius:10px; width:90%; max-width:420px; border:1px solid rgba(255,255,255,0.04); }

    @media (max-width:980px){ .wrap { grid-template-columns: 1fr; gap:12px; padding-bottom:60px; } .header { flex-direction:column; align-items:stretch; gap:10px; } }
  </style>
</head>
<body>
  <!-- Theme toggle -->
  <button id="theme-toggle" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ…">ğŸŒ™</button>

  <div class="wrap">
    <div class="header">
      <div class="title">
        <div class="logo">CS</div>
        <div>
          <h1>Cashier System</h1>
          <div class="subtitle" id="statusSubtitle">Ù…ØªØµÙ„ â€” ØªØ²Ø§Ù…Ù† Ù„Ø­Ø¸ÙŠ</div>
        </div>
      </div>
      <div class="controls">
        <button class="btn" id="btnSave">Ø­ÙØ¸</button>
        <button class="btn primary" id="btnEnd">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ÙØªØ±Ø©</button>
      </div>
    </div>

    <!-- Left panel -->
    <div class="panel">
      <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</h2>
      <div class="items" id="itemsContainer"></div>
      <div style="margin-top:10px; display:flex; gap:8px;">
        <input id="newItemName" placeholder="Ø§Ø³Ù… ØµÙ†Ù Ø¬Ø¯ÙŠØ¯" style="flex:1; padding:10px; border-radius:10px; border:none; background:rgba(255,255,255,0.02); color:inherit; outline:none;">
        <button class="btn" id="addItemBtn">Ø¥Ø¶Ø§ÙØ©</button>
      </div>
    </div>

    <!-- Right panel -->
    <div class="summary">
      <div class="row">
        <div>
          <div class="small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ±</div>
          <div class="big" id="totalItems">0</div>
        </div>
        <div>
          <div class="small">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</div>
          <div class="big" id="totalAmount">0</div>
        </div>
      </div>

      <div style="display:flex; gap:8px; align-items:center;">
        <input id="passwordInput" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ù„Ù…Ø³Ø­" style="flex:1; padding:10px; border-radius:10px; border:none; background:rgba(255,255,255,0.02); color:inherit; outline:none;">
        <button class="btn warn" id="btnClear">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
      </div>

      <div class="actions">
        <button class="btn" id="btnExport">ØªØµØ¯ÙŠØ± JSON</button>
        <button class="btn" id="btnImport">Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
        <input id="importFile" type="file" accept=".json" style="display:none">
      </div>

      <h2 style="margin-top:12px;">Ø³Ø¬Ù„ Ø§Ù„ÙØªØ±Ø§Øª</h2>
      <div class="periods" id="periodsContainer"></div>

      <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
        <div class="small">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ:</div>
        <div id="currentUser" class="small" style="font-weight:700">Ø¶ÙŠÙ</div>
      </div>
    </div>

    <div class="foot">Ù…Ø¨Ù†ÙŠ Ù…Ø¹ â¤ï¸ â€” ØªØ²Ø§Ù…Ù† Ø¹Ø¨Ø± Firebase Realtime Database</div>
  </div>

  <!-- password modal -->
  <div id="password-modal">
    <div class="modal-content">
      <h3>ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„</h3>
      <p>Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©ØŒ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ù…Ø¯ÙŠØ±:</p>
      <input type="password" id="password-input-delete" placeholder="ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø­Ø°Ù">
      <div style="display:flex; gap:10px; margin-top:14px;">
        <button class="btn primary" style="flex:1" id="confirm-delete-btn">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</button>
        <button style="flex:1; background:#888; color:#fff; border:none; padding:10px 14px; border-radius:8px;" id="cancel-delete-btn">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-check-compat.js"></script>

  <script>
    /***** CONFIG - Ø§Ø³ØªØ®Ø¯Ù… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ *****/
    const firebaseConfig = {
      apiKey: "AIzaSyB3k-ETF91TYj-apZynpUOU0D_--aRftSQ",
      authDomain: "cashier-system-18a2f.firebaseapp.com",
      databaseURL: "https://cashier-system-18a2f-default-rtdb.firebaseio.com",
      projectId: "cashier-system-18a2f",
      storageBucket: "cashier-system-18a2f.firebasestorage.app",
      messagingSenderId: "50951955741",
      appId: "1:50951955741:web:abb17d413ac812700c2df4",
      measurementId: "G-Z21M1743KV"
    };
    /*****************************************************/

    // init firebase (compat)
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const PERIODS_REF = db.ref('cashierPeriods');

    // App Check activation (reCAPTCHA Enterprise Site Key)
    // â†’ Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ù…ÙØªØ§Ø­ Ø¨Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø°ÙŠ Ø£Ù†Ø´Ø£ØªÙ‡ ÙÙŠ Google Cloud (ØªÙ… Ø¥Ø¹Ø·Ø§Ø¤Ùƒ Ø§Ù„Ù…ÙØªØ§Ø­ Ø¨Ø§Ù„ÙØ¹Ù„)
    try {
      const appCheck = firebase.appCheck();
      // Ø¶Ø¹ Ù‡Ù†Ø§ Site Key Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:
      appCheck.activate('6Lfau-ErAAAAABSABhgaE7BF0TtdMsWxv4lPehW4', true);
      console.log('App Check activated');
    } catch(e){
      console.warn('App Check activation failed', e);
    }

    /**********************
     * Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø± (Ù†ÙØ³ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ù„Ø¯ÙŠÙƒ)
     **********************/
    const USER_ACCOUNTS = {
      "Ù…Ø¯ÙŠØ± Ø¹Ø§Ù…": { password: "1010", role: "admin" },
      "Ù…Ø­Ù…Ø¯": { password: "5050", role: "cashier" },
      "Ø¹Ù„ÙŠ": { password: "5050", role: "cashier" },
      "Ø³ÙŠØ¯": { password: "5050", role: "cashier" },
      "Ø§Ø­Ù…Ø¯": { password: "5050", role: "cashier" },
      "Ø·Ù‡": { password: "5050", role: "cashier" },
      "Ù…Ø­Ù…ÙˆØ¯": { password: "5050", role: "cashier" },
      "Ø³Ø¹ÙŠØ¯": { password: "5050", role: "cashier" },
      "Ù…Ù…Ø¯ÙˆØ­": { password: "5050", role: "cashier" }
    };

    const DELETION_PASSWORD = "111975";
    let currentUser = null;
    let pastPeriods = [];

    /**********************
     * Ø§Ù„Ø£ØµÙ†Ø§Ù (ØªØ±ØªÙŠØ¨ Ø«Ø§Ø¨Øª ÙƒÙ…Ø§ ÙÙŠ Ù…Ù„ÙÙƒ)
     **********************/
    const ALL_ITEMS_IN_ORDER = [
      "Ø´Ø§ÙˆØ±Ù…Ù‡ ÙƒÙŠØ°Ø±","Ø´Ø§ÙˆØ±Ù…Ù‡ Ø´Ø§Ù…ÙŠ","Ø´Ø§ÙˆØ±Ù…Ù‡ ÙÙŠÙ†Ø§","Ø´Ø§ÙˆØ±Ù…Ù‡ Ø·Ø¨Ù‚",
      "Ù…ÙƒØ±ÙˆÙ†Ù‡","ÙƒØ¨ÙŠØ¨Ù‡","ÙˆØ±Ù‚ Ø¹Ù†Ø¨","Ø³Ù„Ø·Ù‡ Ø®Ø¶Ø±Ø§Ø¡","Ø·Ù…Ø§Ø·Ù… Ù…Ø®Ù„Ù„","Ø¨Ø§Ø°Ù†Ø¬Ø§Ù† Ù…Ø®Ù„Ù„","Ø´ÙŠØ¨Ø³ÙŠ","Ø¨Ø§Ø¨Ø§ ØºÙ†ÙˆØ¬","Ø·Ø±Ø´ÙŠ",
      "ÙƒÙØªÙ‡ Øµ","Ø³Ø¬Ù‚ Øµ","ÙƒØ¨Ø¯Ù‡ Øµ","Ù…Ø® Øµ","Ø±ÙˆØ²Ø¨ÙŠÙ Øµ","Ø¬Ø¨Ù†Ù‡ Ø±ÙˆÙ…ÙŠ","ÙØ±Ø§Ø® Ø¨Ø§Ù†ÙŠÙ‡ Øµ","Ø¨ÙŠÙ Ø¨Ø±Ø¬Ø±","Ø³ÙˆØ³ÙŠØ³ ",
      "ÙƒÙØªÙ‡ Ø´Ø§Ù…ÙŠ","Ø³Ø¬Ù‚ Ø´Ø§Ù…ÙŠ","ÙƒØ¨Ø¯Ù‡ Ø´Ø§Ù…ÙŠ","Ù…Ø® Ø´Ø§Ù…ÙŠ","Ø±ÙˆØ²Ø¨ÙŠÙ Ø´Ø§Ù…ÙŠ","Ø³ÙˆØ³ÙŠØ³ Ø´Ø§Ù…ÙŠ","ÙØ±Ø§Ø® Ø´Ø§Ù…ÙŠ",
      "ÙƒÙØªÙ‡ ÙÙŠÙ†Ø§","Ø³Ø¬Ù‚ ÙÙŠÙ†Ø§","ÙƒØ¨Ø¯Ù‡ ÙÙŠÙ†Ø§","Ù…Ø® ÙÙŠÙ†Ø§","Ø±ÙˆØ²Ø¨ÙŠÙ ÙÙŠÙ†Ø§","Ø³ÙˆØ³ÙŠØ³ ÙÙŠÙ†Ø§","ÙØ±Ø§Ø® ÙÙŠÙ†Ø§",
      "Ø¬Ø¨Ù†Ù‡ Ø±ÙˆÙ…ÙŠ ÙÙŠÙ†Ø§",
      " Ù…Ø§Ù†Ø¬Ùˆ"," ÙØ±Ø§ÙˆÙ„Ù‡"," Ø±Ù…Ø§Ù†"," Ø¨Ø±ØªÙ‚Ø§Ù„","Ø¹Ù†Ø¨"," Ø¬ÙˆØ§ÙÙ‡"," Ù…ÙˆØ²"," ÙƒØ§Ù†ØªØ§Ù„ÙˆØ¨","ÙƒÙˆÙƒØªÙŠÙ„ ",
      "ÙƒÙˆÙ„Ø§","Ø³Ø¨Ø±Ø§ÙŠØª","ÙØ§Ù†ØªØ§","Ø¯Ø§ÙŠØª ","Ù…ÙŠØ§Ù‡ Ù…Ø¹Ø¯Ù†ÙŠÙ‡",
      "Ù„ÙŠÙ…ÙˆÙ†","Ø¨Ø·ÙŠØ®","ÙƒØ§Ù†Ø² Øµ","ÙƒØ§Ù†Ø² Ùƒ"
    ];

    /**********************
     * DOM refs
     **********************/
    const itemsContainer = document.getElementById('itemsContainer');
    const totalItemsEl = document.getElementById('totalItems');
    const totalAmountEl = document.getElementById('totalAmount');
    const periodsContainer = document.getElementById('periodsContainer');
    const btnEnd = document.getElementById('btnEnd');
    const btnSave = document.getElementById('btnSave');
    const btnClear = document.getElementById('btnClear');
    const passwordInput = document.getElementById('passwordInput');
    const addItemBtn = document.getElementById('addItemBtn');
    const newItemName = document.getElementById('newItemName');
    const btnExport = document.getElementById('btnExport');
    const btnImport = document.getElementById('btnImport');
    const importFile = document.getElementById('importFile');
    const currentUserEl = document.getElementById('currentUser');
    const statusSubtitle = document.getElementById('statusSubtitle');
    const themeToggle = document.getElementById('theme-toggle');

    /* utils */
    function idFromName(n){ return 'input-' + n.replace(/\s|\/|\(|\)|[^a-zA-Z0-9\u0600-\u06FF]/g,'_'); }

    /**********************
     * UI builders
     **********************/
    function populateUsernameSelect(){
      const sel = document.getElementById('username-select');
      // if select exists (kept from original) populate it; if not, skip
      if(!sel) return;
      Array.from(sel.options).forEach((opt, i) => { if(i>0) opt.remove(); });
      for(const u in USER_ACCOUNTS){
        const o = document.createElement('option');
        o.value = u;
        o.textContent = u + (USER_ACCOUNTS[u].role === 'admin' ? ' (Ù…Ø¯ÙŠØ±)' : '');
        sel.appendChild(o);
      }
    }

    function ensureState(){
      ALL_ITEMS_IN_ORDER.forEach(it=> { if (window.currentState === undefined) window.currentState = {}; if (window.currentState[it] === undefined) window.currentState[it] = 0; });
    }

    function createItemInputs(){
      itemsContainer.innerHTML = '';
      const grid = document.createElement('div');
      grid.className = 'items-grid';
      // simple layout: create rows for each item
      ALL_ITEMS_IN_ORDER.forEach((itemName, idx) => {
        const safeId = idFromName(itemName);
        const box = document.createElement('div');
        box.className = 'item';
        box.innerHTML = `
          <div style="display:flex; gap:10px; align-items:center;">
            <div class="badge">${idx+1}</div>
            <div>
              <div class="item-name">${itemName}</div>
            </div>
          </div>
          <div class="qty">
            <button class="dec" data-for="${itemName}">âˆ’</button>
            <input id="${safeId}" class="quantity-input" type="number" min="0" value="${(window.currentState && window.currentState[itemName]) || 0}">
            <button class="inc" data-for="${itemName}">+</button>
          </div>
        `;
        itemsContainer.appendChild(box);
      });

      // listeners
      document.querySelectorAll('.quantity-input').forEach(inp=>{
        inp.addEventListener('input', e=>{
          const matched = ALL_ITEMS_IN_ORDER.find(it => idFromName(it) === inp.id);
          if(!matched) return;
          const value = Math.max(0, Math.floor(Number(inp.value) || 0));
          if(!window.currentState) window.currentState = {};
          window.currentState[matched] = value;
          updateSummary();
          publishCurrentStateToFirebase();
        });
      });
      document.querySelectorAll('.inc').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const name = btn.dataset.for;
          if(!window.currentState) window.currentState = {};
          window.currentState[name] = (window.currentState[name] || 0) + 1;
          const el = document.getElementById(idFromName(name));
          if(el) el.value = window.currentState[name];
          updateSummary();
          publishCurrentStateToFirebase();
        });
      });
      document.querySelectorAll('.dec').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const name = btn.dataset.for;
          if(!window.currentState) window.currentState = {};
          window.currentState[name] = Math.max(0, (window.currentState[name] || 0) - 1);
          const el = document.getElementById(idFromName(name));
          if(el) el.value = window.currentState[name];
          updateSummary();
          publishCurrentStateToFirebase();
        });
      });
    }

    function updateSummary(){
      let totalItems = 0;
      let totalAmount = 0;
      ALL_ITEMS_IN_ORDER.forEach(it=>{
        const qty = Number((window.currentState && window.currentState[it]) || 0);
        totalItems += qty;
        // price unknown in original; keep amount as 0 unless user inputs via "total-amount"
      });
      totalItemsEl.textContent = totalItems;
      // totalAmount is taken from input if set
      const val = Number(document.getElementById('total-amount').value || 0);
      totalAmountEl.textContent = val.toFixed(2);
    }

    // Export / Import JSON
    btnExport.addEventListener('click', ()=>{
      const data = { items: ALL_ITEMS_IN_ORDER, currentState: window.currentState || {}, pastPeriods };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'cashier-backup.json'; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    btnImport.addEventListener('click', ()=> importFile.click());
    importFile.addEventListener('change', async (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      const txt = await f.text();
      try{
        const data = JSON.parse(txt);
        if (Array.isArray(data.items)) {
          // merge item list but preserve order
          // (we keep your original items list to avoid breaking)
        }
        window.currentState = data.currentState || {};
        pastPeriods = data.pastPeriods || [];
        saveData();
        renderAll();
        alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
      }catch(err){
        alert('Ø®Ø·Ø£ ÙÙŠ Ù…Ù„Ù Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯');
      }
    });

    // periods UI
    function renderPeriods(){
      periodsContainer.innerHTML = '';
      if(!pastPeriods || !pastPeriods.length){
        periodsContainer.innerHTML = '<div class="small" style="color:var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØªØ±Ø§Øª Ø¨Ø¹Ø¯</div>';
        return;
      }
      [...pastPeriods].reverse().forEach((p, idx)=>{
        const el = document.createElement('div');
        el.className = 'period-card';
        el.innerHTML = `
          <div>
            <div style="font-weight:800">ÙØªØ±Ø© ${p.id || (idx+1)}</div>
            <div class="small">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${p.date || p.when || ''} ${p.time || ''}</div>
            <div class="small">Ø¨ÙˆØ§Ø³Ø·Ø©: ${p.user || 'Ø¶ÙŠÙ'}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-weight:900; color:var(--danger);">${p.totalAmount || 0}</div>
            <div class="small">${p.totalOrders || 0} Ø¹Ù†ØµØ±</div>
          </div>
        `;
        periodsContainer.appendChild(el);
      });
    }

    // end period
    btnEnd.addEventListener('click', ()=>{
      const total = Number(document.getElementById('total-amount').value || 0);
      const when = Date.now();
      if(isNaN(total) || total <= 0){ alert('Ø§Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©'); return; }
      const totalOrders = Number(totalItemsEl.textContent) || 0;
      if(totalOrders === 0){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.'); return; }
      const periodLog = {
        id: pastPeriods.length + 1,
        time: new Date().toLocaleTimeString('ar-EG'),
        date: new Date().toLocaleDateString('ar-EG'),
        totalAmount: total,
        totalOrders,
        itemsLog: {...(window.currentState||{})},
        user: currentUser ? currentUser.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'
      };
      pastPeriods.push(periodLog);
      saveData();
      displayPastPeriods();
      // reset inputs
      document.getElementById('total-amount').value = '';
      ALL_ITEMS_IN_ORDER.forEach(it => {
        const el = document.getElementById(idFromName(it));
        if(el) el.value = 0;
      });
      window.currentState = {};
      updateSummary();
      publishCurrentStateToFirebase();
      alert('ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ÙØªØ±Ø© ÙˆØ­ÙØ¸Ù‡Ø§.');
    });

    function displayPastPeriods(){ renderPeriods(); }

    function generateDailySalesReport(){
      if(pastPeriods.length === 0){ alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±."); return; }
      const combined = {}; let money = 0, units = 0;
      pastPeriods.forEach(p => {
        money += Number(p.totalAmount) || 0;
        units += Number(p.totalOrders) || 0;
        for(const it in p.itemsLog) combined[it] = (combined[it] || 0) + p.itemsLog[it];
      });
      const ordered = ALL_ITEMS_IN_ORDER;
      const rows = Object.keys(combined).map(k => `<tr><td style="padding:8px;border:1px solid rgba(255,255,255,0.04)">${k}</td><td style="padding:8px;border:1px solid rgba(255,255,255,0.04)">${combined[k]}</td></tr>`).join('');
      const reportHTML = `<table style="width:100%;border-collapse:collapse"><thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th></tr></thead><tbody>${rows}</tbody></table>`;
      document.getElementById('report-date').textContent = new Date().toLocaleDateString('ar-EG');
      document.getElementById('detailed-sales-summary').innerHTML = reportHTML;
      document.getElementById('final-report-container').style.display = 'block';
      setTimeout(()=> document.getElementById('final-report-container').scrollIntoView({behavior:'smooth'}),50);
    }

    function promptDailyReport(){ generateDailySalesReport(); }

    function clearAllData(){ // show modal confirms deletion
      if(!currentUser || currentUser.role !== 'admin'){ alert("ØµÙ„Ø§Ø­ÙŠØ© Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ù…Ù‚ØªØµØ±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯ÙŠØ±."); return; }
      document.getElementById('password-modal').style.display = 'flex';
      document.getElementById('password-input-delete').focus();
    }

    document.getElementById('cancel-delete-btn').addEventListener('click', ()=> { document.getElementById('password-modal').style.display='none'; });

    document.getElementById('confirm-delete-btn').addEventListener('click', executeClearData);

    function executeClearData(){
      const entered = document.getElementById('password-input-delete').value;
      document.getElementById('password-modal').style.display = 'none';
      document.getElementById('password-input-delete').value = '';
      if(entered === DELETION_PASSWORD){
        try{ localStorage.removeItem('cashierPeriods'); } catch(e){}
        pastPeriods = [];
        PERIODS_REF.set([]).catch(()=>{});
        displayPastPeriods();
        alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.');
      } else {
        alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.');
      }
    }

    /**********************
     * saveData() & loadData() with Firebase + localStorage
     **********************/
    function saveData(){
      try{ localStorage.setItem('cashierPeriods', JSON.stringify(pastPeriods)); } catch(e){ console.warn('local save failed', e); }
      PERIODS_REF.set(pastPeriods)
        .then(()=> console.log('Saved to Firebase'))
        .catch(e=>console.warn('Firebase save error', e));
    }

    function loadData(){
      // read once from firebase
      PERIODS_REF.once('value').then(snapshot=>{
        if(snapshot && snapshot.exists()){
          pastPeriods = snapshot.val() || [];
          displayPastPeriods();
          updateSummary();
          console.log('Loaded from Firebase');
        } else {
          // fallback to localStorage
          const s = localStorage.getItem('cashierPeriods');
          if(s){ try{ pastPeriods = JSON.parse(s); } catch(e){ pastPeriods = []; } displayPastPeriods(); updateSummary(); }
        }
      }).catch(err=>{
        console.warn('Firebase read failed, fallback to local', err);
        const s = localStorage.getItem('cashierPeriods');
        if(s){ try{ pastPeriods = JSON.parse(s); } catch(e){ pastPeriods = []; } displayPastPeriods(); updateSummary(); }
      });

      // realtime updates
      PERIODS_REF.on('value', snap=>{
        const val = snap.val();
        if(val){
          pastPeriods = val;
          displayPastPeriods();
          updateSummary();
          console.log('Realtime update applied');
        }
      });
    }

    /**********************
     * publish current UI state to Firebase (simple sync)
     **********************/
    function publishCurrentStateToFirebase(){
      const payload = {
        items: window.currentState || {},
        lastUpdatedAt: Date.now(),
        lastUpdatedBy: currentUser ? currentUser.name : 'guest'
      };
      db.ref('currentState').set(payload).catch(()=>{});
      db.ref('meta').set({ lastUpdatedAt: payload.lastUpdatedAt, lastUpdatedBy: payload.lastUpdatedBy }).catch(()=>{});
    }

    /**********************
     * Authentication (keep local select login as-is)
     **********************/
    function populateLoginSelectAndInit(){
      // if select exists, populate it
      const sel = document.getElementById('username-select');
      if(!sel) return;
      Array.from(sel.options).forEach((opt,i)=>{ if(i>0) opt.remove(); });
      for(const u in USER_ACCOUNTS){
        const o = document.createElement('option'); o.value = u; o.textContent = u + (USER_ACCOUNTS[u].role==='admin'?' (Ù…Ø¯ÙŠØ±)':''); sel.appendChild(o);
      }
    }

    function login(){
      const sel = document.getElementById('username-select');
      if(!sel) return; // if select not present in page (older UI), skip
      const enteredUsername = sel.value;
      const enteredPassword = document.getElementById('password-input').value;
      if(!enteredUsername){ alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…."); return; }
      const user = USER_ACCOUNTS[enteredUsername];
      if(user && enteredPassword === user.password){
        currentUser = { name: enteredUsername, role: user.role };
        document.getElementById('login-screen') && (document.getElementById('login-screen').style.display = 'none');
        document.getElementById('cashier-content') && (document.getElementById('cashier-content').style.display = 'block');
        document.querySelector('#cashier-content h1') && (document.querySelector('#cashier-content h1').textContent = `Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù (Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${currentUser.name})`);
        updatePermissionsUI();
        createItemInputs();
        currentUserEl.textContent = currentUser.name;
      } else {
        alert("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
      }
    }

    function logout(){
      if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) return;
      currentUser = null;
      document.getElementById('cashier-content') && (document.getElementById('cashier-content').style.display = 'none');
      document.getElementById('login-screen') && (document.getElementById('login-screen').style.display = 'flex');
      document.getElementById('username-select') && (document.getElementById('username-select').value = '');
      document.getElementById('password-input') && (document.getElementById('password-input').value = '');
      document.getElementById('final-report-container') && (document.getElementById('final-report-container').style.display = 'none');
      document.querySelectorAll('.quantity-input').forEach(i => i.value = 0);
      document.getElementById('total-amount').value = '';
      updateSummary();
    }

    function updatePermissionsUI(){
      const btn = document.getElementById('clear-data-btn');
      if(!btn) return;
      if(currentUser && currentUser.role === 'admin') btn.style.display = 'block';
      else btn.style.display = 'none';
    }

    /**********************
     * Init & events
     **********************/
    document.addEventListener('DOMContentLoaded', ()=>{
      populateLoginSelectAndInit();
      // If your UI uses login-screen/hiding show/hide, keep as is. Otherwise render directly.
      // initialize state & UI
      if(!window.currentState) window.currentState = {};
      createItemInputs();
      loadData();
      // attach some buttons
      btnSave.addEventListener('click', ()=> { saveData(); alert('ØªÙ… Ø§Ù„Ø­ÙØ¸'); });
      btnClear.addEventListener('click', ()=> { const pw = passwordInput.value || ''; if(pw !== DELETION_PASSWORD){ alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); return; } if(!confirm('Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ')) return; pastPeriods=[]; saveData(); displayPastPeriods(); alert('ØªÙ… Ø§Ù„Ù…Ø³Ø­'); });
      addItemBtn.addEventListener('click', ()=>{
        const name = (newItemName.value||'').trim();
        if(!name) return alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… ØµÙ†Ù'); ALL_ITEMS_IN_ORDER.push(name); window.currentState[name]=0; newItemName.value=''; createItemInputs();
      });
      btnEnd && (btnEnd.addEventListener && btnEnd.addEventListener('click', ()=>{})); // handler already set above
      btnExport && (btnExport.addEventListener && btnExport.addEventListener('click', ()=>{})); // already set
      btnImport && (btnImport.addEventListener && btnImport.addEventListener('click', ()=>{}));
      // theme
      (function(){ const saved = localStorage.getItem('cs_theme_dark'); if(saved === '0') setTheme(false); else setTheme(true); })();
      themeToggle.addEventListener('click', ()=> setTheme(!(document.body.classList.contains('light'))));
      // autosave publishes state periodically
      setInterval(()=> { publishCurrentStateToFirebase(); }, 20000);
    });

    /**********************
     * Theme toggle
     **********************/
    function setTheme(light){
      if(light){ document.body.classList.add('light'); document.getElementById('theme-toggle').textContent='â˜€ï¸'; }
      else { document.body.classList.remove('light'); document.getElementById('theme-toggle').textContent='ğŸŒ™'; }
      localStorage.setItem('cs_theme_dark', light ? '0' : '1');
    }

  </script>
</body>
</html>
