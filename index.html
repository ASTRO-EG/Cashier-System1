<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cashier System</title>

  <!-- Google Font: Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    /* ---------------- Theme / Base ---------------- */
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --muted:#94a3b8;
      --text:#e6eef8;
      --accent:#06b6d4;
      --accent2:#7c3aed;
      --glass: rgba(255,255,255,0.03);
      --success:#16a34a;
      --danger:#ef4444;
      --transition: .22s ease;
      --font: 'Poppins', sans-serif;
    }
    body { margin:0; font-family:var(--font); -webkit-font-smoothing:antialiased; background:linear-gradient(180deg,var(--bg),#08101a); color:var(--text); padding:18px; }
    .wrap{ max-width:1100px; margin:8px auto; display:grid; grid-template-columns: 380px 1fr; gap:18px; align-items:start; }

    /* header */
    .header { grid-column:1/-1; display:flex; align-items:center; justify-content:space-between; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:14px 18px; box-shadow:0 6px 18px rgba(2,6,23,0.6); }
    .title { display:flex; align-items:center; gap:12px; }
    .logo { width:48px; height:48px; border-radius:10px; background:linear-gradient(135deg,var(--accent),var(--accent2)); display:flex; align-items:center; justify-content:center; font-weight:700; color:white; font-size:18px; }
    h1{ margin:0; font-size:18px; }
    .subtitle{ font-size:12px; color:var(--muted); margin-top:2px; }

    /* theme toggle top-left icon */
    #theme-toggle {
      position: fixed; top:12px; left:12px; z-index:9999; width:44px; height:44px; border-radius:999px;
      display:flex; align-items:center; justify-content:center; background:var(--card); color:var(--text);
      border:1px solid rgba(255,255,255,0.03); cursor:pointer; font-size:18px; box-shadow:0 6px 18px rgba(0,0,0,0.5);
      transition: transform .18s ease, background .18s ease;
    }
    #theme-toggle:hover{ transform: scale(1.06); }

    /* left panel (items) */
    .panel { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:14px; box-shadow: 0 6px 18px rgba(0,0,0,0.6); }
    .items { display:flex; flex-direction:column; gap:10px; max-height:66vh; overflow:auto; padding-right:6px; }
    .item { display:flex; gap:10px; align-items:center; justify-content:space-between; padding:8px; border-radius:10px; background:transparent; }
    .badge { min-width:44px; height:44px; border-radius:10px; background:rgba(255,255,255,0.02); display:flex;align-items:center;justify-content:center; font-weight:700; color:var(--accent); font-size:13px; }
    .item-name { font-weight:600; }
    .qty { width:96px; display:flex; gap:6px; align-items:center; }
    .qty input { width:56px; padding:8px; border-radius:8px; border:none; text-align:center; outline:none; font-weight:600; background:rgba(255,255,255,0.02); color:var(--text); }

    /* right panel */
    .summary { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:14px; box-shadow: 0 6px 18px rgba(0,0,0,0.6); display:flex; flex-direction:column; gap:10px; }
    .row { display:flex; justify-content:space-between; align-items:center; padding:8px 6px; }
    .big { font-size:24px; font-weight:800; }
    .small { font-size:13px; color:var(--muted); }

    .actions { display:flex; gap:8px; align-items:center; margin-top:6px; }
    .periods { margin-top:8px; display:flex; flex-direction:column; gap:8px; max-height:36vh; overflow:auto; padding-right:6px; }
    .period-card { background: rgba(255,255,255,0.02); padding:10px; border-radius:10px; display:flex; justify-content:space-between; align-items:center; }

    .btn { background:var(--glass); border:1px solid rgba(255,255,255,0.04); color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; font-size:13px; }
    .btn.primary { background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#fff; border:none; }
    .btn.warn { background:transparent; border:1px solid rgba(255,80,80,0.12); color:var(--danger); }

    .foot { grid-column:1/-1; text-align:center; font-size:12px; color:var(--muted); margin-top:6px; }

    /* modal */
    #password-modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:999; }
    .modal-content{ background:var(--card); color:var(--text); padding:20px; border-radius:10px; width:90%; max-width:420px; border:1px solid rgba(255,255,255,0.04); }

    @media (max-width:980px){ .wrap { grid-template-columns: 1fr; gap:12px; padding-bottom:60px; } .header { flex-direction:column; align-items:stretch; gap:10px; } }
  </style>
</head>
<body>
  <!-- Theme toggle -->
  <button id="theme-toggle" title="تبديل الثيم">🌙</button>

  <div class="wrap">
    <div class="header">
      <div class="title">
        <div class="logo">CS</div>
        <div>
          <h1>Cashier System</h1>
          <div class="subtitle" id="statusSubtitle">متصل — تزامن لحظي</div>
        </div>
      </div>
      <div class="controls">
        <button class="btn" id="btnSave">حفظ</button>
        <button class="btn primary" id="btnEnd">إنهاء الفترة</button>
      </div>
    </div>

    <!-- Left panel -->
    <div class="panel">
      <h2>قائمة الأصناف</h2>
      <div class="items" id="itemsContainer"></div>
      <div style="margin-top:10px; display:flex; gap:8px;">
        <input id="newItemName" placeholder="اسم صنف جديد" style="flex:1; padding:10px; border-radius:10px; border:none; background:rgba(255,255,255,0.02); color:inherit; outline:none;">
        <button class="btn" id="addItemBtn">إضافة</button>
      </div>
    </div>

    <!-- Right panel -->
    <div class="summary">
      <div class="row">
        <div>
          <div class="small">إجمالي العناصر</div>
          <div class="big" id="totalItems">0</div>
        </div>
        <div>
          <div class="small">الإجمالي الكلي</div>
          <div class="big" id="totalAmount">0</div>
        </div>
      </div>

      <div style="display:flex; gap:8px; align-items:center;">
        <input id="passwordInput" type="password" placeholder="كلمة مرور المدير للمسح" style="flex:1; padding:10px; border-radius:10px; border:none; background:rgba(255,255,255,0.02); color:inherit; outline:none;">
        <button class="btn warn" id="btnClear">مسح السجل</button>
      </div>

      <div class="actions">
        <button class="btn" id="btnExport">تصدير JSON</button>
        <button class="btn" id="btnImport">استيراد JSON</button>
        <input id="importFile" type="file" accept=".json" style="display:none">
      </div>

      <h2 style="margin-top:12px;">سجل الفترات</h2>
      <div class="periods" id="periodsContainer"></div>

      <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
        <div class="small">المستخدم الحالي:</div>
        <div id="currentUser" class="small" style="font-weight:700">ضيف</div>
      </div>
    </div>

    <div class="foot">مبني مع ❤️ — تزامن عبر Firebase Realtime Database</div>
  </div>

  <!-- password modal -->
  <div id="password-modal">
    <div class="modal-content">
      <h3>تأكيد حذف السجل</h3>
      <p>لإجراء عملية الحذف النهائية، أدخل كلمة سر المدير:</p>
      <input type="password" id="password-input-delete" placeholder="كلمة سر الحذف">
      <div style="display:flex; gap:10px; margin-top:14px;">
        <button class="btn primary" style="flex:1" id="confirm-delete-btn">تأكيد الحذف</button>
        <button style="flex:1; background:#888; color:#fff; border:none; padding:10px 14px; border-radius:8px;" id="cancel-delete-btn">إلغاء</button>
      </div>
    </div>
  </div>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-check-compat.js"></script>

  <script>
    /***** CONFIG - استخدم إعدادات Firebase الخاصة بك *****/
    const firebaseConfig = {
      apiKey: "AIzaSyB3k-ETF91TYj-apZynpUOU0D_--aRftSQ",
      authDomain: "cashier-system-18a2f.firebaseapp.com",
      databaseURL: "https://cashier-system-18a2f-default-rtdb.firebaseio.com",
      projectId: "cashier-system-18a2f",
      storageBucket: "cashier-system-18a2f.firebasestorage.app",
      messagingSenderId: "50951955741",
      appId: "1:50951955741:web:abb17d413ac812700c2df4",
      measurementId: "G-Z21M1743KV"
    };
    /*****************************************************/

    // init firebase (compat)
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const PERIODS_REF = db.ref('cashierPeriods');

    // App Check activation (reCAPTCHA Enterprise Site Key)
    // → استبدل المفتاح بالمفتاح الذي أنشأته في Google Cloud (تم إعطاؤك المفتاح بالفعل)
    try {
      const appCheck = firebase.appCheck();
      // ضع هنا Site Key الخاص بك:
      appCheck.activate('6Lfau-ErAAAAABSABhgaE7BF0TtdMsWxv4lPehW4', true);
      console.log('App Check activated');
    } catch(e){
      console.warn('App Check activation failed', e);
    }

    /**********************
     * حسابات المستخدمين وكلمات السر (نفس النظام الموجود لديك)
     **********************/
    const USER_ACCOUNTS = {
      "مدير عام": { password: "1010", role: "admin" },
      "محمد": { password: "5050", role: "cashier" },
      "علي": { password: "5050", role: "cashier" },
      "سيد": { password: "5050", role: "cashier" },
      "احمد": { password: "5050", role: "cashier" },
      "طه": { password: "5050", role: "cashier" },
      "محمود": { password: "5050", role: "cashier" },
      "سعيد": { password: "5050", role: "cashier" },
      "ممدوح": { password: "5050", role: "cashier" }
    };

    const DELETION_PASSWORD = "111975";
    let currentUser = null;
    let pastPeriods = [];

    /**********************
     * الأصناف (ترتيب ثابت كما في ملفك)
     **********************/
    const ALL_ITEMS_IN_ORDER = [
      "شاورمه كيذر","شاورمه شامي","شاورمه فينا","شاورمه طبق",
      "مكرونه","كبيبه","ورق عنب","سلطه خضراء","طماطم مخلل","باذنجان مخلل","شيبسي","بابا غنوج","طرشي",
      "كفته ص","سجق ص","كبده ص","مخ ص","روزبيف ص","جبنه رومي","فراخ بانيه ص","بيف برجر","سوسيس ",
      "كفته شامي","سجق شامي","كبده شامي","مخ شامي","روزبيف شامي","سوسيس شامي","فراخ شامي",
      "كفته فينا","سجق فينا","كبده فينا","مخ فينا","روزبيف فينا","سوسيس فينا","فراخ فينا",
      "جبنه رومي فينا",
      " مانجو"," فراوله"," رمان"," برتقال","عنب"," جوافه"," موز"," كانتالوب","كوكتيل ",
      "كولا","سبرايت","فانتا","دايت ","مياه معدنيه",
      "ليمون","بطيخ","كانز ص","كانز ك"
    ];

    /**********************
     * DOM refs
     **********************/
    const itemsContainer = document.getElementById('itemsContainer');
    const totalItemsEl = document.getElementById('totalItems');
    const totalAmountEl = document.getElementById('totalAmount');
    const periodsContainer = document.getElementById('periodsContainer');
    const btnEnd = document.getElementById('btnEnd');
    const btnSave = document.getElementById('btnSave');
    const btnClear = document.getElementById('btnClear');
    const passwordInput = document.getElementById('passwordInput');
    const addItemBtn = document.getElementById('addItemBtn');
    const newItemName = document.getElementById('newItemName');
    const btnExport = document.getElementById('btnExport');
    const btnImport = document.getElementById('btnImport');
    const importFile = document.getElementById('importFile');
    const currentUserEl = document.getElementById('currentUser');
    const statusSubtitle = document.getElementById('statusSubtitle');
    const themeToggle = document.getElementById('theme-toggle');

    /* utils */
    function idFromName(n){ return 'input-' + n.replace(/\s|\/|\(|\)|[^a-zA-Z0-9\u0600-\u06FF]/g,'_'); }

    /**********************
     * UI builders
     **********************/
    function populateUsernameSelect(){
      const sel = document.getElementById('username-select');
      // if select exists (kept from original) populate it; if not, skip
      if(!sel) return;
      Array.from(sel.options).forEach((opt, i) => { if(i>0) opt.remove(); });
      for(const u in USER_ACCOUNTS){
        const o = document.createElement('option');
        o.value = u;
        o.textContent = u + (USER_ACCOUNTS[u].role === 'admin' ? ' (مدير)' : '');
        sel.appendChild(o);
      }
    }

    function ensureState(){
      ALL_ITEMS_IN_ORDER.forEach(it=> { if (window.currentState === undefined) window.currentState = {}; if (window.currentState[it] === undefined) window.currentState[it] = 0; });
    }

    function createItemInputs(){
      itemsContainer.innerHTML = '';
      const grid = document.createElement('div');
      grid.className = 'items-grid';
      // simple layout: create rows for each item
      ALL_ITEMS_IN_ORDER.forEach((itemName, idx) => {
        const safeId = idFromName(itemName);
        const box = document.createElement('div');
        box.className = 'item';
        box.innerHTML = `
          <div style="display:flex; gap:10px; align-items:center;">
            <div class="badge">${idx+1}</div>
            <div>
              <div class="item-name">${itemName}</div>
            </div>
          </div>
          <div class="qty">
            <button class="dec" data-for="${itemName}">−</button>
            <input id="${safeId}" class="quantity-input" type="number" min="0" value="${(window.currentState && window.currentState[itemName]) || 0}">
            <button class="inc" data-for="${itemName}">+</button>
          </div>
        `;
        itemsContainer.appendChild(box);
      });

      // listeners
      document.querySelectorAll('.quantity-input').forEach(inp=>{
        inp.addEventListener('input', e=>{
          const matched = ALL_ITEMS_IN_ORDER.find(it => idFromName(it) === inp.id);
          if(!matched) return;
          const value = Math.max(0, Math.floor(Number(inp.value) || 0));
          if(!window.currentState) window.currentState = {};
          window.currentState[matched] = value;
          updateSummary();
          publishCurrentStateToFirebase();
        });
      });
      document.querySelectorAll('.inc').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const name = btn.dataset.for;
          if(!window.currentState) window.currentState = {};
          window.currentState[name] = (window.currentState[name] || 0) + 1;
          const el = document.getElementById(idFromName(name));
          if(el) el.value = window.currentState[name];
          updateSummary();
          publishCurrentStateToFirebase();
        });
      });
      document.querySelectorAll('.dec').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const name = btn.dataset.for;
          if(!window.currentState) window.currentState = {};
          window.currentState[name] = Math.max(0, (window.currentState[name] || 0) - 1);
          const el = document.getElementById(idFromName(name));
          if(el) el.value = window.currentState[name];
          updateSummary();
          publishCurrentStateToFirebase();
        });
      });
    }

    function updateSummary(){
      let totalItems = 0;
      let totalAmount = 0;
      ALL_ITEMS_IN_ORDER.forEach(it=>{
        const qty = Number((window.currentState && window.currentState[it]) || 0);
        totalItems += qty;
        // price unknown in original; keep amount as 0 unless user inputs via "total-amount"
      });
      totalItemsEl.textContent = totalItems;
      // totalAmount is taken from input if set
      const val = Number(document.getElementById('total-amount').value || 0);
      totalAmountEl.textContent = val.toFixed(2);
    }

    // Export / Import JSON
    btnExport.addEventListener('click', ()=>{
      const data = { items: ALL_ITEMS_IN_ORDER, currentState: window.currentState || {}, pastPeriods };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'cashier-backup.json'; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    btnImport.addEventListener('click', ()=> importFile.click());
    importFile.addEventListener('change', async (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      const txt = await f.text();
      try{
        const data = JSON.parse(txt);
        if (Array.isArray(data.items)) {
          // merge item list but preserve order
          // (we keep your original items list to avoid breaking)
        }
        window.currentState = data.currentState || {};
        pastPeriods = data.pastPeriods || [];
        saveData();
        renderAll();
        alert('تم استيراد البيانات');
      }catch(err){
        alert('خطأ في ملف الاستيراد');
      }
    });

    // periods UI
    function renderPeriods(){
      periodsContainer.innerHTML = '';
      if(!pastPeriods || !pastPeriods.length){
        periodsContainer.innerHTML = '<div class="small" style="color:var(--muted);">لا توجد فترات بعد</div>';
        return;
      }
      [...pastPeriods].reverse().forEach((p, idx)=>{
        const el = document.createElement('div');
        el.className = 'period-card';
        el.innerHTML = `
          <div>
            <div style="font-weight:800">فترة ${p.id || (idx+1)}</div>
            <div class="small">التاريخ: ${p.date || p.when || ''} ${p.time || ''}</div>
            <div class="small">بواسطة: ${p.user || 'ضيف'}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-weight:900; color:var(--danger);">${p.totalAmount || 0}</div>
            <div class="small">${p.totalOrders || 0} عنصر</div>
          </div>
        `;
        periodsContainer.appendChild(el);
      });
    }

    // end period
    btnEnd.addEventListener('click', ()=>{
      const total = Number(document.getElementById('total-amount').value || 0);
      const when = Date.now();
      if(isNaN(total) || total <= 0){ alert('ادخل قيمة الماكينة'); return; }
      const totalOrders = Number(totalItemsEl.textContent) || 0;
      if(totalOrders === 0){ alert('لا يوجد أصناف مسجلة في هذه الفترة.'); return; }
      const periodLog = {
        id: pastPeriods.length + 1,
        time: new Date().toLocaleTimeString('ar-EG'),
        date: new Date().toLocaleDateString('ar-EG'),
        totalAmount: total,
        totalOrders,
        itemsLog: {...(window.currentState||{})},
        user: currentUser ? currentUser.name : 'غير معروف'
      };
      pastPeriods.push(periodLog);
      saveData();
      displayPastPeriods();
      // reset inputs
      document.getElementById('total-amount').value = '';
      ALL_ITEMS_IN_ORDER.forEach(it => {
        const el = document.getElementById(idFromName(it));
        if(el) el.value = 0;
      });
      window.currentState = {};
      updateSummary();
      publishCurrentStateToFirebase();
      alert('تم إنهاء الفترة وحفظها.');
    });

    function displayPastPeriods(){ renderPeriods(); }

    function generateDailySalesReport(){
      if(pastPeriods.length === 0){ alert("لا يوجد بيانات مسجلة لإنشاء التقرير."); return; }
      const combined = {}; let money = 0, units = 0;
      pastPeriods.forEach(p => {
        money += Number(p.totalAmount) || 0;
        units += Number(p.totalOrders) || 0;
        for(const it in p.itemsLog) combined[it] = (combined[it] || 0) + p.itemsLog[it];
      });
      const ordered = ALL_ITEMS_IN_ORDER;
      const rows = Object.keys(combined).map(k => `<tr><td style="padding:8px;border:1px solid rgba(255,255,255,0.04)">${k}</td><td style="padding:8px;border:1px solid rgba(255,255,255,0.04)">${combined[k]}</td></tr>`).join('');
      const reportHTML = `<table style="width:100%;border-collapse:collapse"><thead><tr><th>الصنف</th><th>الكمية</th></tr></thead><tbody>${rows}</tbody></table>`;
      document.getElementById('report-date').textContent = new Date().toLocaleDateString('ar-EG');
      document.getElementById('detailed-sales-summary').innerHTML = reportHTML;
      document.getElementById('final-report-container').style.display = 'block';
      setTimeout(()=> document.getElementById('final-report-container').scrollIntoView({behavior:'smooth'}),50);
    }

    function promptDailyReport(){ generateDailySalesReport(); }

    function clearAllData(){ // show modal confirms deletion
      if(!currentUser || currentUser.role !== 'admin'){ alert("صلاحية حذف السجل مقتصرة على المدير."); return; }
      document.getElementById('password-modal').style.display = 'flex';
      document.getElementById('password-input-delete').focus();
    }

    document.getElementById('cancel-delete-btn').addEventListener('click', ()=> { document.getElementById('password-modal').style.display='none'; });

    document.getElementById('confirm-delete-btn').addEventListener('click', executeClearData);

    function executeClearData(){
      const entered = document.getElementById('password-input-delete').value;
      document.getElementById('password-modal').style.display = 'none';
      document.getElementById('password-input-delete').value = '';
      if(entered === DELETION_PASSWORD){
        try{ localStorage.removeItem('cashierPeriods'); } catch(e){}
        pastPeriods = [];
        PERIODS_REF.set([]).catch(()=>{});
        displayPastPeriods();
        alert('تم حذف السجل بالكامل.');
      } else {
        alert('كلمة السر غير صحيحة.');
      }
    }

    /**********************
     * saveData() & loadData() with Firebase + localStorage
     **********************/
    function saveData(){
      try{ localStorage.setItem('cashierPeriods', JSON.stringify(pastPeriods)); } catch(e){ console.warn('local save failed', e); }
      PERIODS_REF.set(pastPeriods)
        .then(()=> console.log('Saved to Firebase'))
        .catch(e=>console.warn('Firebase save error', e));
    }

    function loadData(){
      // read once from firebase
      PERIODS_REF.once('value').then(snapshot=>{
        if(snapshot && snapshot.exists()){
          pastPeriods = snapshot.val() || [];
          displayPastPeriods();
          updateSummary();
          console.log('Loaded from Firebase');
        } else {
          // fallback to localStorage
          const s = localStorage.getItem('cashierPeriods');
          if(s){ try{ pastPeriods = JSON.parse(s); } catch(e){ pastPeriods = []; } displayPastPeriods(); updateSummary(); }
        }
      }).catch(err=>{
        console.warn('Firebase read failed, fallback to local', err);
        const s = localStorage.getItem('cashierPeriods');
        if(s){ try{ pastPeriods = JSON.parse(s); } catch(e){ pastPeriods = []; } displayPastPeriods(); updateSummary(); }
      });

      // realtime updates
      PERIODS_REF.on('value', snap=>{
        const val = snap.val();
        if(val){
          pastPeriods = val;
          displayPastPeriods();
          updateSummary();
          console.log('Realtime update applied');
        }
      });
    }

    /**********************
     * publish current UI state to Firebase (simple sync)
     **********************/
    function publishCurrentStateToFirebase(){
      const payload = {
        items: window.currentState || {},
        lastUpdatedAt: Date.now(),
        lastUpdatedBy: currentUser ? currentUser.name : 'guest'
      };
      db.ref('currentState').set(payload).catch(()=>{});
      db.ref('meta').set({ lastUpdatedAt: payload.lastUpdatedAt, lastUpdatedBy: payload.lastUpdatedBy }).catch(()=>{});
    }

    /**********************
     * Authentication (keep local select login as-is)
     **********************/
    function populateLoginSelectAndInit(){
      // if select exists, populate it
      const sel = document.getElementById('username-select');
      if(!sel) return;
      Array.from(sel.options).forEach((opt,i)=>{ if(i>0) opt.remove(); });
      for(const u in USER_ACCOUNTS){
        const o = document.createElement('option'); o.value = u; o.textContent = u + (USER_ACCOUNTS[u].role==='admin'?' (مدير)':''); sel.appendChild(o);
      }
    }

    function login(){
      const sel = document.getElementById('username-select');
      if(!sel) return; // if select not present in page (older UI), skip
      const enteredUsername = sel.value;
      const enteredPassword = document.getElementById('password-input').value;
      if(!enteredUsername){ alert("الرجاء اختيار اسم المستخدم."); return; }
      const user = USER_ACCOUNTS[enteredUsername];
      if(user && enteredPassword === user.password){
        currentUser = { name: enteredUsername, role: user.role };
        document.getElementById('login-screen') && (document.getElementById('login-screen').style.display = 'none');
        document.getElementById('cashier-content') && (document.getElementById('cashier-content').style.display = 'block');
        document.querySelector('#cashier-content h1') && (document.querySelector('#cashier-content h1').textContent = `برنامج تسجيل الأصناف (المستخدم: ${currentUser.name})`);
        updatePermissionsUI();
        createItemInputs();
        currentUserEl.textContent = currentUser.name;
      } else {
        alert("اسم المستخدم أو كلمة المرور غير صحيحة.");
      }
    }

    function logout(){
      if(!confirm("هل أنت متأكد من تسجيل الخروج؟")) return;
      currentUser = null;
      document.getElementById('cashier-content') && (document.getElementById('cashier-content').style.display = 'none');
      document.getElementById('login-screen') && (document.getElementById('login-screen').style.display = 'flex');
      document.getElementById('username-select') && (document.getElementById('username-select').value = '');
      document.getElementById('password-input') && (document.getElementById('password-input').value = '');
      document.getElementById('final-report-container') && (document.getElementById('final-report-container').style.display = 'none');
      document.querySelectorAll('.quantity-input').forEach(i => i.value = 0);
      document.getElementById('total-amount').value = '';
      updateSummary();
    }

    function updatePermissionsUI(){
      const btn = document.getElementById('clear-data-btn');
      if(!btn) return;
      if(currentUser && currentUser.role === 'admin') btn.style.display = 'block';
      else btn.style.display = 'none';
    }

    /**********************
     * Init & events
     **********************/
    document.addEventListener('DOMContentLoaded', ()=>{
      populateLoginSelectAndInit();
      // If your UI uses login-screen/hiding show/hide, keep as is. Otherwise render directly.
      // initialize state & UI
      if(!window.currentState) window.currentState = {};
      createItemInputs();
      loadData();
      // attach some buttons
      btnSave.addEventListener('click', ()=> { saveData(); alert('تم الحفظ'); });
      btnClear.addEventListener('click', ()=> { const pw = passwordInput.value || ''; if(pw !== DELETION_PASSWORD){ alert('كلمة المرور غير صحيحة'); return; } if(!confirm('مسح السجل بالكامل؟')) return; pastPeriods=[]; saveData(); displayPastPeriods(); alert('تم المسح'); });
      addItemBtn.addEventListener('click', ()=>{
        const name = (newItemName.value||'').trim();
        if(!name) return alert('ادخل اسم صنف'); ALL_ITEMS_IN_ORDER.push(name); window.currentState[name]=0; newItemName.value=''; createItemInputs();
      });
      btnEnd && (btnEnd.addEventListener && btnEnd.addEventListener('click', ()=>{})); // handler already set above
      btnExport && (btnExport.addEventListener && btnExport.addEventListener('click', ()=>{})); // already set
      btnImport && (btnImport.addEventListener && btnImport.addEventListener('click', ()=>{}));
      // theme
      (function(){ const saved = localStorage.getItem('cs_theme_dark'); if(saved === '0') setTheme(false); else setTheme(true); })();
      themeToggle.addEventListener('click', ()=> setTheme(!(document.body.classList.contains('light'))));
      // autosave publishes state periodically
      setInterval(()=> { publishCurrentStateToFirebase(); }, 20000);
    });

    /**********************
     * Theme toggle
     **********************/
    function setTheme(light){
      if(light){ document.body.classList.add('light'); document.getElementById('theme-toggle').textContent='☀️'; }
      else { document.body.classList.remove('light'); document.getElementById('theme-toggle').textContent='🌙'; }
      localStorage.setItem('cs_theme_dark', light ? '0' : '1');
    }

  </script>
</body>
</html>
